{% extends 'base.html' %}

{% block title %}{{ data.project_name }} - SuperMega++{% endblock %}

{% block extra_css %}
<!-- Add Bootstrap Icons CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<!-- Self-hosted highlight.js styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/default.min.css') }}" id="code-theme-light">
<link rel="stylesheet" href="{{ url_for('static', filename='css/vs2015.min.css') }}" id="code-theme-dark" disabled>
<style>
	.project-header {
		background-color: #f8f9fa;
		padding: 15px;
		border-radius: 5px;
		margin-bottom: 20px;
	}

	.file-explorer {
		max-height: 600px;
		overflow-y: auto;
	}

	.file-list-item {
		cursor: pointer;
		padding: 8px 12px;
		border-radius: 4px;
	}

	.file-list-item:hover {
		background-color: #f8f9fa;
	}

	.file-list-item.active {
		background-color: #007bff;
		color: white;
	}

	.code-container {
		position: relative;
		height: 500px;
		overflow: auto;
		border: 1px solid #dee2e6;
		border-radius: 0.25rem;
	}

	.code-content {
		font-family: monospace;
		padding: 1rem;
		min-height: 100%;
		margin: 0;
	}

	/* Dark mode for code container only */
	.dark-mode .code-container {
		background-color: #1e1e1e;
		border-color: #444;
	}

	/* Editable fields styling */
	.editable-field {
		display: inline-block;
		position: relative;
		cursor: pointer;
	}

	.editable-field:hover .edit-icon {
		visibility: visible;
	}

	.edit-icon {
		visibility: hidden;
		margin-left: 8px;
		color: #6c757d;
		cursor: pointer;
	}

	.editable-input {
		width: 100%;
		padding: 5px;
		border: 1px solid #ced4da;
		border-radius: 4px;
	}
</style>
{% endblock %}

{% block content %}
<div class="project-header">
	<div class="d-flex justify-content-between align-items-center">
		<h1>
			<span class="editable-field" id="projectNameField" data-field="project_name"
				data-value="{{ data.project_name }}">
				{{ data.project_name }}
				<i class="bi bi-pencil-square edit-icon"></i>
			</span>
		</h1>
		<div>
			<button class="btn btn-primary" id="saveProjectBtn">Save</button>
			<button class="btn btn-success" id="runProjectBtn">Run</button>
		</div>
	</div>
	<div>
		<span class="editable-field" id="projectCommentField" data-field="project_comment"
			data-value="{{ data.project_comment }}">
			{% if data.project_comment %}
			<p class="text-muted">{{ data.project_comment }}</p>
			{% else %}
			<p class="text-muted fst-italic">Add a project comment...</p>
			{% endif %}
			<i class="bi bi-pencil-square edit-icon"></i>
		</span>
	</div>

	<div class="row mt-3">
		<div class="col-md-3">
			<div class="form-check form-switch">
				<input class="form-check-input" type="checkbox" id="optimizationSwitch">
				<label class="form-check-label" for="optimizationSwitch">Enable Optimization</label>
			</div>
		</div>
		<div class="col-md-3">
			<select class="form-select" id="targetPlatform">
				<option selected>x86_64</option>
				<option>ARM</option>
				<option>RISC-V</option>
			</select>
		</div>
		<div class="col-md-3">
			<div class="form-check form-switch">
				<input class="form-check-input" type="checkbox" id="debugSwitch" checked>
				<label class="form-check-label" for="debugSwitch">Debug Mode</label>
			</div>
		</div>
		<div class="col-md-3">
			<button class="btn btn-outline-secondary" id="settingsBtn">Additional Settings</button>
		</div>
	</div>
</div>

<div class="row">
	<!-- File Explorer -->
	<div class="col-md-3">
		<div class="card mb-4">
			<div class="card-header">
				<h5>Files</h5>
			</div>
			<div class="card-body p-0">
				<div class="file-explorer" id="fileExplorer">
					<ul class="list-group list-group-flush">
						{% for file in project_files %}
						<li class="list-group-item file-list-item {% if file == default_file %}active{% endif %}"
							data-filename="{{ file }}">
							<i class="bi bi-file-earmark-text"></i> {{ file }}
						</li>
						{% endfor %}
					</ul>
				</div>
			</div>
		</div>
	</div>

	<!-- File Content Viewer -->
	<div class="col-md-9">
		<div class="card mb-4">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5 id="currentFileName">{{ default_file }}</h5>
				<div class="btn-group btn-group-sm">
					<button class="btn btn-outline-secondary" id="toggleThemeBtn">Dark Mode</button>
				</div>
			</div>
			<div class="card-body p-0">
				<div class="code-container" id="codeContainer">
					<pre><code class="code-content language-c" id="fileContent">{{ file_contents.get(default_file, '') }}</code></pre>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Hidden divs to store file contents -->
<div style="display: none;" id="fileContentsData">
	{% for filename, content in file_contents.items() %}
	<div data-filename="{{ filename }}">{{ content }}</div>
	{% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Self-hosted highlight.js core and language scripts -->
<script src="{{ url_for('static', filename='js/highlight.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/c.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/json.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/x86asm.min.js') }}"></script>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		const fileContent = document.getElementById('fileContent');
		const currentFileName = document.getElementById('currentFileName');
		const codeContainer = document.getElementById('codeContainer');
		const fileItems = document.querySelectorAll('.file-list-item');
		const fileContentsData = document.getElementById('fileContentsData');
		const lightTheme = document.getElementById('code-theme-light');
		const darkTheme = document.getElementById('code-theme-dark');

		// Get content for a specific file from the hidden data
		function getFileContent(filename) {
			const fileDiv = fileContentsData.querySelector(`div[data-filename="${filename}"]`);
			return fileDiv ? fileDiv.textContent : '';
		}

		// Determine language for syntax highlighting
		function getLanguageForFile(filename) {
			if (filename.endsWith('.json')) {
				return 'json';
			} else if (filename.endsWith('.c') || filename.endsWith('.h')) {
				return 'c';
			} else if (filename.endsWith('.asm') || filename.endsWith('.s')) {
				return 'x86asm';
			} else {
				return 'plaintext';
			}
		}

		// Initialize syntax highlighting
		hljs.highlightElement(fileContent);

		// Dark mode handling
		let isDarkMode = false;

		// Toggle theme button
		document.getElementById('toggleThemeBtn').addEventListener('click', function () {
			isDarkMode = !isDarkMode;

			if (isDarkMode) {
				codeContainer.classList.add('dark-mode');
				this.textContent = 'Light Mode';
				lightTheme.disabled = true;
				darkTheme.disabled = false;
			} else {
				codeContainer.classList.remove('dark-mode');
				this.textContent = 'Dark Mode';
				lightTheme.disabled = false;
				darkTheme.disabled = true;
			}

			// Re-highlight code with new theme
			hljs.highlightElement(fileContent);
		});

		// File click handling
		fileItems.forEach(function (item) {
			item.addEventListener('click', function () {
				// Remove active class from all items
				fileItems.forEach(function (i) {
					i.classList.remove('active');
				});

				// Add active class to clicked item
				this.classList.add('active');

				// Get the filename
				const filename = this.getAttribute('data-filename');
				currentFileName.textContent = filename;

				// Get content from our hidden div
				const content = getFileContent(filename);
				fileContent.textContent = content;

				// Update language for syntax highlighting
				const language = getLanguageForFile(filename);
				fileContent.className = `code-content language-${language}`;

				// Re-highlight the code
				hljs.highlightElement(fileContent);
			});
		});

		// Mock functionality for the Save button
		document.getElementById('saveProjectBtn').addEventListener('click', function () {
			alert('Save functionality will be implemented in a future version.');
		});

		// Mock functionality for the Run button
		document.getElementById('runProjectBtn').addEventListener('click', function () {
			alert('Run functionality will be implemented in a future version.');
		});

		// Mock functionality for the Settings button
		document.getElementById('settingsBtn').addEventListener('click', function () {
			alert('Additional settings will be available in a future version.');
		});

		// EDITABLE FIELDS FUNCTIONALITY
		const editableFields = document.querySelectorAll('.editable-field');

		// Helper function to make a field editable
		function makeEditable(field) {
			const fieldName = field.getAttribute('data-field');
			const currentValue = field.getAttribute('data-value');
			const isProjectName = fieldName === 'project_name';

			// Store original content to restore if needed
			const originalContent = field.innerHTML;

			// Create input element
			const input = document.createElement(isProjectName ? 'input' : 'textarea');
			input.className = 'editable-input';
			input.value = currentValue || '';

			if (isProjectName) {
				input.style.fontSize = '2rem'; // Match h1 size
			} else {
				input.rows = 2;
				input.style.width = '100%';
			}

			// Replace field content with input
			field.innerHTML = '';
			field.appendChild(input);

			// Focus the input
			input.focus();

			// Handle input blur (click outside)
			input.addEventListener('blur', function () {
				saveFieldValue(field, input.value, fieldName);
			});

			// Handle Enter key press
			input.addEventListener('keydown', function (e) {
				if (e.key === 'Enter' && !e.shiftKey) {
					e.preventDefault();
					saveFieldValue(field, input.value, fieldName);
				} else if (e.key === 'Escape') {
					// Restore original content on Escape
					field.innerHTML = originalContent;
				}
			});
		}

		// Helper function to save the field value
		function saveFieldValue(field, value, fieldName) {
			// Get the current project
			const projectName = "{{ session.get('current_project') }}";

			// Create a form to submit
			const form = document.createElement('form');
			form.method = 'POST';
			form.action = `/api/projects/update/${projectName}`;

			// Create the field input
			const fieldInput = document.createElement('input');
			fieldInput.type = 'hidden';
			fieldInput.name = 'field';
			fieldInput.value = fieldName;
			form.appendChild(fieldInput);

			// Create the value input
			const valueInput = document.createElement('input');
			valueInput.type = 'hidden';
			valueInput.name = 'value';
			valueInput.value = value;
			form.appendChild(valueInput);

			// Submit the form
			document.body.appendChild(form);
			form.submit();
		}

		// Add click event to all editable fields
		editableFields.forEach(field => {
			field.addEventListener('click', function () {
				makeEditable(this);
			});
		});
	});
</script>

{% endblock %}
